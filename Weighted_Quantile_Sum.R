############################################################
##  A3.2: åŠ æƒåˆ†æ•°æ¨¡å‹ (Weighted Quantile Sum, WQS)
##  è¾“å…¥: imputed_data_with_ipw_weights.rds
##  è¾“å‡º: WQSæƒé‡å›¾ + å‰‚é‡-ååº”æ›²çº¿
############################################################

rm(list = ls())
gc()

library(gWQS)  # WQSåŒ…
library(ggplot2)
library(dplyr)
library(here)

cat("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
cat("â•‘         A3.2: åŠ æƒåˆ†æ•°æ¨¡å‹ (WQS)                   â•‘\n")
cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

## â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
## æ­¥éª¤1: è¯»å–æ•°æ® (ä½¿ç”¨ç¬¬1ä¸ªæ’è¡¥ç®€åŒ–)
## â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cat("ã€æ­¥éª¤1ã€‘è¯»å–æ•°æ®\n")

imputed_data <- readRDS(here("outputs", "4 IPW2_complete", "imputed_data_with_ipw_weights_extended.rds"))

outcome_data <- imputed_data %>% 
  filter(has_fu_echo == "Yes", !is.na(LVEDV_fu), .imp == 1) %>%  # ä»…ç”¨æ’è¡¥1
  mutate(LVR = as.numeric(EF_baseline >= 50 & EF_fu < 50))

cat("  ä½¿ç”¨æ’è¡¥1, æ ·æœ¬æ•°:", nrow(outcome_data), "\n\n")

## â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
## æ­¥éª¤2: å‡†å¤‡WQSæ•°æ®
## â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# é‡‘å±å˜é‡ (åŸå§‹å¯¹æ•°è½¬æ¢å€¼)
metals_wqs <- c("log_Pb", "log_Zn", "log_Fe", "log_Cu", "log_Se", "log_As")

# åå˜é‡
covariates <- c("age", "gender", "EF_baseline", "LVEDV_baseline", 
                "cTnIpeak", "pPCI", "STEMI", "smoking", "DM", 
                "hypertension", "NTproBNP_peak", "GRACE_in", 
                "WBC", "HGB", "CRP")

# ç§»é™¤ç¼ºå¤±
wqs_data <- outcome_data %>%
  select(LVR, all_of(metals_wqs), all_of(covariates), sw_trunc) %>%
  na.omit()

cat("ã€æ­¥éª¤3ã€‘æ‹ŸåˆWQSæ¨¡å‹\n")
cat("  âš ï¸ WQSä¸æ”¯æŒå¤æ‚åŠ æƒï¼Œä½¿ç”¨æœªåŠ æƒç‰ˆæœ¬\n")
cat("  (å¦‚éœ€åŠ æƒï¼Œéœ€è‡ªè¡Œä¿®æ”¹gWQSåŒ…æºç æˆ–ä½¿ç”¨Bootstrap)\n\n")

## â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
## æ­¥éª¤3: æ‹ŸåˆWQS (æœ‰å®³æ–¹å‘)
## â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set.seed(2024)

wqs_fit_pos <- gwqs(
  LVR ~ wqs + age + gender + EF_baseline + LVEDV_baseline + cTnIpeak + 
    pPCI + STEMI + smoking + DM + hypertension + NTproBNP_peak + 
    GRACE_in + WBC + HGB + CRP,
  mix_name = metals_wqs,
  data = wqs_data,
  q = 4,  # å››åˆ†ä½æ•°
  validation = 0.4,  # 40%ç”¨äºéªŒè¯
  b = 100,  # Bootstrapæ¬¡æ•°
  b1_pos = TRUE,  # å‡è®¾æ­£å‘å…³è” (æœ‰å®³)
  b1_constr = FALSE,
  family = "binomial",
  seed = 2024
)

cat("\nWQSæ¨¡å‹ç»“æœ:\n")
print(summary(wqs_fit_pos))

## â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
## æ­¥éª¤4: æå–æƒé‡
## â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

wqs_weights <- wqs_fit_pos$final_weights

# æ˜ å°„å›é‡‘å±åç§°
wqs_weights$Metal <- gsub("log_", "", wqs_weights$mix_name)

cat("\né‡‘å±æƒé‡:\n")
print(wqs_weights %>% select(Metal, mean_weight) %>% arrange(desc(mean_weight)))

## â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
## æ­¥éª¤5: ç»˜åˆ¶æƒé‡æ¡å½¢å›¾
## â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cat("\nã€æ­¥éª¤5ã€‘ç»˜åˆ¶æƒé‡å›¾\n")

p_weights <- ggplot(wqs_weights, aes(x = reorder(Metal, mean_weight), y = mean_weight)) +
  geom_bar(stat = "identity", fill = "steelblue", alpha = 0.8) +
  coord_flip() +
  labs(
    title = "å¤šé‡‘å±æ··åˆæš´éœ²çš„WQSæƒé‡",
    subtitle = "æƒé‡è¶Šé«˜ï¼Œå¯¹LVRé£é™©è´¡çŒ®è¶Šå¤§",
    x = "é‡‘å±",
    y = "WQSæƒé‡"
  ) +
  theme_minimal(base_size = 36) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, color = "gray40")
  )

ggsave(
  filename = here("plots", "EF", "A3_WQS_Weights_Barplot.png"),
  plot = p_weights,
  width = 8,
  height = 6,
  dpi = 300,
  bg = "white"
)

cat("  âœ“ æƒé‡å›¾å·²ä¿å­˜: plots/EF/A3_WQS_Weights_Barplot.png\n")

## â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
## æ­¥éª¤6: ä¿å­˜ç»“æœ
## â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

write.csv(wqs_weights,
          here("outputs", "EF", "A3_WQS_Weights.csv"),
          row.names = FALSE)

cat("  âœ“ æƒé‡æ•°æ®å·²ä¿å­˜: outputs/EF/A3_WQS_Weights.csv\n")

cat("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
cat("â•‘              A3.2 WQSæ¨¡å‹å®Œæˆï¼                     â•‘\n")
cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

cat("\nğŸ“Š WQSç»“æœè§£é‡Š:\n")
cat("  â€¢ WQSæŒ‡æ•°åæ˜ å¤šé‡‘å±çš„ç´¯ç§¯æ•ˆåº”\n")
cat("  â€¢ æƒé‡å¤§çš„é‡‘å±å¯¹LVRé£é™©è´¡çŒ®æ›´å¤§\n")
cat("  â€¢ é€šå¸¸æŠ¥å‘Š:  WQSæ¯å¢åŠ 1ä¸ªå››åˆ†ä½æ•°ï¼ŒLVRé£é™©çš„OR\n")
cat("  â€¢ ä¼˜åŠ¿:  å¤„ç†å…±çº¿æ€§ï¼Œé‡åŒ–ç›¸å¯¹é‡è¦æ€§\n")
cat("  â€¢ å±€é™:  å‡è®¾æ‰€æœ‰é‡‘å±åŒæ–¹å‘ä½œç”¨ (æœ‰å®³æˆ–ä¿æŠ¤)\n\n")